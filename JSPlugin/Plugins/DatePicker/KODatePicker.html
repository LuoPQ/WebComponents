<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <style>
        div, a, dl, dt, dd { margin: 0; padding: 0; }
        .datepicker { border-color: #ff8f00; background: none repeat scroll 0 0 #fff; box-shadow: 1px 1px 3px #333333; width: 230px; position: relative; padding: 5px; }
            .datepicker .month-prev, .datepicker .month-next { border-radius: 5px; border: 1px solid #ccc; cursor: pointer; height: 20px; width: 20px; }
            .datepicker .month-prev { float: left; }
            .datepicker .month-next { float: right; }
                .datepicker .month-prev:before, .datepicker .month-next:before { content: ""; display: block; position: relative; left: 7px; top: 4px; width: 0; height: 0; border-bottom: 6px dashed transparent; border-top: 6px dashed transparent; }
            .datepicker .month-prev:before { border-right: 6px solid #ff8f00; }
            .datepicker .month-next:before { border-left: 6px solid #ff8f00; }
            .datepicker dl { text-align: center; color: #404040; font: 12px/22px Georgia; }
                .datepicker dl .month { width: 100%; font-weight: 700; padding-bottom: 5px; }
                .datepicker dl .week { display: inline-block; height: 24px; line-height: 24px; width: 30px; border-bottom: 1px solid #ccc; border-top: 1px solid #ccc; }
            .datepicker dd a { color: #404040; display: inline-block; height: 22px; line-height: 22px; margin: 1px 0 0 1px; outline: medium none; overflow: hidden; text-decoration: none; width: 29px; cursor: pointer; }
                .datepicker dd a:hover { background-color: #ff8f00; color: #fff; }
            .datepicker dd span { font-weight: bold; font-size: 10px; }
            .datepicker dd .disabled, .datepicker dd .disabled:hover { background-color: transparent; color: #999; cursor: default; }
    </style>
</head>
<body>
    <input type="text" data-bind="value:selectedText,event:{'focus':showDatePicker},clickBubble: false" />
    <div class="datepicker" data-bind="visible:datePickerVisible">
        <dl>
            <dt class="month">
                <a class="month-prev" data-bind="click:prevMonth,clickBubble: false"></a>
                <span data-bind="text:currentDateText"></span>
                <a class="month-next" data-bind="click:nextMonth"></a>
            </dt>
            <dt class="week">日</dt>
            <dt class="week">一</dt>
            <dt class="week">二</dt>
            <dt class="week">三</dt>
            <dt class="week">四</dt>
            <dt class="week">五</dt>
            <dt class="week">六</dt>
            <dd data-bind="foreach:dayList">
                <a class="" data-bind="css:{'disabled':disabled},html:dateText,click:select"></a>
            </dd>
        </dl>
    </div>
    <script src="../../Scripts/knockout-3.2.0.js"></script>
    <script>
        (function () {
            function datePickerVM(params) {
                var self = this;

                //======辅助方法=======
                function createKoDate(date, month) {
                    var koDate = {};
                    var currentMonth = date.getMonth();
                    var minDate = self.minDate();

                    koDate.year = date.getFullYear();
                    koDate.month = currentMonth + 1;
                    koDate.date = date.getDate();
                    koDate.day = date.getDay() + 1;
                    koDate.dateText = koDate.date;
                    koDate.disabled = date.getFullYear() < minDate.getFullYear()
                        || date.getMonth() < minDate.getMonth()
                        || date.getDate() < minDate.getDate()
                        || month != currentMonth;

                    if (month == currentMonth) {
                        var today = new Date();
                        if (date.getDate() == today.getDate()
                            && date.getFullYear() == today.getFullYear()
                            && date.getMonth() == today.getMonth()) {
                            koDate.dateText = '<span>今天</span>';
                        }
                    }
                    else {
                        koDate.dateText = "";
                    }

                    koDate.select = function () {
                        if (!koDate.disabled) {
                            self.selectedDay(koDate);
                        }
                    }
                    return koDate;
                }

                function getDateList(currentDate) {
                    var currentYear = currentDate.getFullYear();
                    var currentMonth = currentDate.getMonth();

                    var firstDay = new Date(currentYear, currentMonth, 1);
                    var lastDay = new Date(currentYear, currentMonth + 1, 0);

                    var list = [];
                    for (var i = 0; i < firstDay.getDay() ; i++) {
                        list.push(createKoDate(new Date(currentYear, currentMonth - 1, i), currentMonth));
                    }
                    for (var i = 1; i <= lastDay.getDate() ; i++) {
                        list.push(createKoDate(new Date(currentYear, currentMonth, i), currentMonth));
                    }
                    for (var i = 0; i < 6 - lastDay.getDay() ; i++) {
                        list.push(createKoDate(new Date(currentYear, currentMonth + 1, i + 1), currentMonth));
                    }

                    return list;
                }

                var today = new Date();

                //最小天数
                self.minDate = ko.observable(params.minDate || new Date());

                //选择的天数
                self.selectedDay = ko.observable();
                self.selectedText = ko.computed(function () {
                    var selectedDay = self.selectedDay();
                    if (selectedDay) {
                        self.datePickerVisible(false);
                        return selectedDay.year + "-" + selectedDay.month + "-" + selectedDay.date;
                    }
                    return "";
                })

                //当前日期

                var minDate = self.minDate();
                self.currentDate = ko.observable(new Date(minDate.getFullYear(), minDate.getMonth(), minDate.getDate()));

                self.currentDateText = ko.computed(function () {
                    var currentDate = self.currentDate();
                    return currentDate.getFullYear() + "年" + (currentDate.getMonth() + 1) + "月";
                })

                //天数列表
                self.dayList = ko.computed(function () {
                    return getDateList(self.currentDate());
                })

                //是否显示日期选择框
                self.datePickerVisible = ko.observable(true);

                //是否在选择
                self.showDatePicker = function () {
                    self.datePickerVisible(true);
                }

                document.onclick = function () {
                    setTimeout(function () {
                        self.datePickerVisible(false);
                    }, 150);
                }

                self.changeMonth = function (data, event) {

                }

                self.prevMonth = function (data, event) {
                    console.log(data);
                    console.log(event);
                    var currentDate = self.currentDate();
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    self.currentDate(currentDate);
                }

                self.nextMonth = function () {
                    var currentDate = self.currentDate();
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    self.currentDate(currentDate);
                }


            }

            var params = {
                //minDate: new Date(2014, 11, 1)
            };
            ko.applyBindings(new datePickerVM(params));
        })();
    </script>
</body>
</html>
